
name: mesheryctl-smp

on:
  [push, repository_dispatch]
  #   branches: [ master ]
  # pull_request:
  #   branches: [ master ]
  

jobs:
  perftest:
    runs-on: ubuntu-latest
    steps:
     # - uses: actions/checkout@v2
      - name: Install mesheryctl
        run: |
          /bin/bash -c "curl -LO 'https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl'"
          /bin/bash -c "curl -L https://git.io/meshery | PLATFORM=kubernetes  bash -"
                    
      - name: export token
        run: export TOKEN="${{ secrets.AUTH_TOKEN }}"

      - name: pipe to file
        run: |
          echo '{ "meshery-provider": "Meshery", "token": null }' | jq '.token = env.TOKEN' > ~/auth.json

      - name: setup minikube
        uses: manusa/actions-setup-minikube@v2.4.1
        with:
          minikube version: 'v1.16.0'
          kubernetes version: 'v1.19.2'

      - name: deploy meshery
        run: |
          mesheryctl system context create k8s -p kubernetes
          mesheryctl system context switch k8s
          mesheryctl system start --yes

      - name: configure docker bridge
        run: |
          docker network connect bridge meshery_meshery_1
          docker network connect minikube meshery_meshery_1
        
      - name:  configure meshery
        run: |
          kubectl config view --minify --flatten > ~/minified_config
          mv ~/minified_config ~/.kube/config


      - name: expose deployment
        run: |
           kubectl port-forward svc/meshery -n meshery 31980:31980 /dev/null 2&>1

      - name: perfom smi conformance tests
        run: mesheryctl perf --name "mesheryctl action perf tests" --url https://www.google.com --qps 4 --concurrent-requests 1 --duration 6s --token ~/auth.json
  
